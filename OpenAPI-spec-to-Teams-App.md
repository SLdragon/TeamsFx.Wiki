# Introduction
If you're looking to integrate your existing API service with Teams App, our `api2teams` CLI tool can help you seamlessly convert your APIs from OpenAPI spec file into a command bot Teams App with ease.

# Prerequisite
Before running this CLI and deploying your generated Teams App to Azure or your local development machine, please ensure that you have the following prerequisites in place:

- [Node.js](https://nodejs.org/), supported versions: 14, 16, 18
- An [Microsoft 365 account for development](https://docs.microsoft.com/microsoftteams/platform/toolkit/accounts)
- [Teams Toolkit Visual Studio Code Extension](https://aka.ms/teams-toolkit) version 5.0.0 and higher or [TeamsFx CLI](https://aka.ms/teamsfx-cli)
- [Option] If you want to deploy this APP to Azure, you also need an Azure subscription. If you don't have an Azure subscription, [create a free account](https://azure.microsoft.com/en-us/free/) before you begin


# Quick Start

- Install the CLI
  ```
  npm install @microsoft/api2teams@latest -g
  ```

- Download [sample-open-api-spec.yml](https://github.com/OfficeDev/TeamsFx/blob/api2teams/packages/api2teams/sample-spec/sample-open-api-spec.yml) to current working directory

- Run the command below to convert `sample-open-api-spec.yml` file to Teams App, it will generate teams project to `generated-teams-app` folder
  ```
  api2teams sample-open-api-spec.yml
  ```

- You can specify which folder to generate teams project as below
  ```
  api2teams sample-open-api-spec.yml -o my-custom-teams-app-folder
  ```

- If you want to overwrite the output folder, you can use `-f` parameters
  ```
  api2teams sample-open-api-spec.yml -o my-custom-teams-app-folder -f
  ```

- If you have other personal swagger yaml files, you can also use this CLI tool to covert them.

# Run Generated Teams App

- Open generated folder in VSCode, and make sure you have installed [Teams Toolkit >= 5.0.0](https://marketplace.visualstudio.com/items?itemName=TeamsDevApp.ms-teams-vscode-extension).

- Click F5 in VSCode to run the Teams App to view the result (Below is the example of teams app converted by [test4.yml](./tests/e2e/swagger-files/test4.yml) file)

  - Send message `GET /pets/1` to Bot, bot will send a response adaptive card:

    ![](https://github.com/OfficeDev/TeamsFx/wiki/api2teams/workflow1.png)

  - Send message `GET /pets` to Bot, it will first send request a request adaptive card:

    ![](https://github.com/OfficeDev/TeamsFx/wiki/api2teams/workflow2.png)

  - Input value in the request adaptive card, and then click GET button, it will send back response adaptive card:

    ![](https://github.com/OfficeDev/TeamsFx/wiki/api2teams/workflow3.png)

  - Send message `GET /pets?limit=1`, it will send back response adaptive card directly:

    ![](https://github.com/OfficeDev/TeamsFx/wiki/api2teams/workflow4.png)

# CLI Usage

The CLI name is `api2teams`. Usage is as below:

```
Usage: api2teams [options] <yaml>

Convert open api spec file to Teams APP project, only for GET operation

Arguments:
  yaml                   yaml file path to convert

Options:
  -o, --output [string]  output folder for teams app (default: "./generated-teams-app")
  -f, --force            force overwrite the output folder
  -v, --version          output the current version
  -h, --help             display help for command
```

User can input below command to generate Teams App to default or specific folder:

```bash
api2teams sample-open-api-spec.yml # generate teams app to default folder ./generated-teams-app
api2teams sample-open-api-spec.yml -o ./my-app # generate teams app to ./my-app folder
api2teams sample-open-api-spec.yml -o ./my-app -f # generate teams app to ./my-app folder, and force overwrite output folder
api2teams -h # show help message
api2teams -v # show version information
```

# Converted Teams App Folder Structure

The converted app is a normal command bot TeamsFx project that will contain following files/folders:
| Folder / File | Contents |
| - | - |
| `teamsapp.yml` | Main project file describes your application configuration and defines the set of actions to run in each lifecycle stages |
| `teamsapp.local.yml`| This overrides `teamsapp.yml` with actions that enable local execution and debugging |
| `env/`| Name / value pairs are stored in environment files and used by `teamsapp.yml` to customize the provisioning and deployment rules |
| `.vscode/` | VSCode files for debugging |
| `appPackage/` | Templates for the Teams application manifest |
| `infra/` | Templates for provisioning Azure resources |
| `src/` | The source code for the application |

In the src folder, there are 4 subfolders and a index.ts file insdie:

* adaptiveCards folder
    - This folder contains adaptive card generated by Convert Tool based on APIs. Each API will generate two adaptive cards, one is `*RequestCard.json`, and another is `*ResponseCard.json`. Request card is for user to input parameters and click button to send request, and response card is used to render api response data.
    > Using this pattern is more clear than use component name (although it may produce duplicated cards), because component name can be used by multiple apis, and it is not easy for user to know which adaptive card is for specific api

* apis folder
    - This folder contains two ts file, one is for mock api calls (mockApiProvider.ts) and another is for real api calls (realApiProvider.ts). For real api calls, user need to manually update these files to call real backend service

* cardActions folder
    - This folder contains card action handlers, when user click action button in the request adaptive card, it would use these handlers to get response and render response adaptive card.

* commands folder
    - This folder contains bot command handlers, when user send messages, it will match the api, and send back request adaptive card. There is a special command handler which named `helpCommandHandler` which is used to show help messages.

* index.ts file
    - Index file using `restify` as web service framework to host bot server, and register command handlers and action handlers for bot to handle use messages and button clicking event. 

Below is workflow when user input command message with all required parameters:

![](https://github.com/OfficeDev/TeamsFx/wiki/api2teams/flow2.png)


In the event that a user inputs a command message with missing required parameters, the following workflow is triggered:
![](https://github.com/OfficeDev/TeamsFx/wiki/api2teams/flow1.png)

# Customize the Project
To learn more about the template, [visit the documentation on GitHub](https://aka.ms/teamsfx-command-new). You can find more scenarios like:

- [Customize the trigger pattern](https://aka.ms/teamsfx-command-new#customize-the-trigger-pattern)
- [Customize the Adaptive Card with dynamic content](https://aka.ms/teamsfx-command-new#how-to-build-command-response-using-adaptive-card-with-dynamic-content)
- [Change the way to initialize the bot](https://aka.ms/teamsfx-command-new#customize-initialization)
- [Connect to an existing API](https://aka.ms/teamsfx-command-new#connect-to-existing-api)
- [Access Microsoft Graph](https://aka.ms/teamsfx-add-sso-new)

# Current Limitations
1. Only OpenAPI version 3.0.0 or higher is supported.
1. Authorization properties inside OpenAPI spec is not supported
1. Only GET operations are supported.
1. The webhooks property is not supported and will be ignored during conversion.
1. The oneOf, anyOf, and not keywords are not supported, not because there is no better way to represent them in adaptive cards. Only the allOf keyword is supported.
1. For request cards, there is no proper element to represent array types in adaptive cards, so users need to input array values manually.
1. Adaptive cards do not support file uploads, so if an API contains file uploads, it cannot be converted to adaptive card.
1. Due to Teams limitations, command intellisense can only contain a maximum of 10 items.

# References
- [Teams Toolkit extension](https://learn.microsoft.com/en-us/microsoftteams/platform/toolkit/teams-toolkit-fundamentals)
- [Adaptive card official site](https://adaptivecards.io/)
- [Adaptive card designer](https://adaptivecards.io/designer)
- [Swagger Parser](https://github.com/APIDevTools/swagger-parser)
- [Swagger Samples](https://github.com/OAI/OpenAPI-Specification)
